created: 20250226075958389
creator: uzvg
description: zsh Shellè„šæœ¬çš„è°ƒè¯•æ–¹å¼
modified: 20250630010140298
modifier: uzvg
progress: Completed
rating: Plain
tags: zsh Shell PermanentNotes
title: zsh Shellè„šæœ¬è°ƒè¯•æ–¹å¼
type: text/vnd.tiddlywiki
visibility: Public

!! ğŸŸ¢ 1. ''å†…å»ºçš„è°ƒè¯•é€‰é¡¹''

zsh å†…ç½®äº†å¤šç§éå¸¸æœ‰ç”¨çš„â€œè°ƒè¯•æ¨¡å¼â€ï¼š

!!! ï¼ˆ1ï¼‰é€è¡Œæ‰§è¡Œï¼š`set -x`

åœ¨è„šæœ¬ä¸­æ·»åŠ ï¼š

```zsh
set -x
```

æˆ–è€…åœ¨æ‰§è¡Œæ—¶å¸¦ä¸Šï¼š

```zsh
zsh -x your_script.zsh
```

âœ… ä½œç”¨ï¼š
åœ¨æ‰§è¡Œæ¯ä¸€è¡Œå‘½ä»¤å‰ï¼ŒæŠŠ''å±•å¼€åçš„å‘½ä»¤''æ‰“å°åˆ° stderrï¼ˆéå¸¸ç›´è§‚ï¼‰ã€‚

> ''æç¤º''ï¼šè°ƒè¯•å®Œåˆ«å¿˜è®°å…³é—­ï¼š

```zsh
set +x
```

!!! ï¼ˆ2ï¼‰è¯­æ³•æ£€æŸ¥ï¼š`-n`

åªæ£€æŸ¥è¯­æ³•ï¼Œä¸æ‰§è¡Œï¼š

```zsh
zsh -n your_script.zsh
```

âœ… ä½œç”¨ï¼š
ä¸ä¼šçœŸæ­£è¿è¡Œè„šæœ¬ï¼ˆä¹Ÿå°±ä¸ä¼šç ´åæ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œå…ˆç¡®è®¤è¯­æ³•æ— è¯¯ã€‚

!!! ï¼ˆ3ï¼‰æ˜¾ç¤ºæ‰§è¡Œå‰çš„æ‰€æœ‰å±•å¼€ï¼š`set -v`

é€è¡Œæ‰“å°è„šæœ¬å†…å®¹ï¼ˆåŸå§‹è¡Œï¼Œè€Œä¸æ˜¯å±•å¼€åï¼‰ã€‚
å’Œ `set -x` ä¸åŒï¼Œå®ƒæ‰“å°åŸå§‹è„šæœ¬è¡Œã€‚

!!! ï¼ˆ4ï¼‰ä¸¥æ ¼æ¨¡å¼ï¼š`set -e` å’Œ `set -u`

* `set -e`: ä¸€æ—¦æœ‰å‘½ä»¤è¿”å›éé›¶çŠ¶æ€ï¼Œè„šæœ¬ç«‹å³é€€å‡ºã€‚
* `set -u`: é‡åˆ°''æœªå®šä¹‰çš„å˜é‡''ï¼Œç«‹å³æŠ¥é”™ã€‚

ç¤ºä¾‹ï¼š

```zsh
set -eu
```

âœ… ä½œç”¨ï¼š
å¯ä»¥é˜²æ­¢æ‹¼é”™å˜é‡åæˆ–å¿½ç•¥é”™è¯¯ã€‚

!! ğŸŸ¢ 2. ''å¹²è·‘æ¨¡å¼ï¼šecho/print æ¨¡æ‹Ÿæ‰§è¡Œ''

åœ¨å±é™©æ“ä½œï¼ˆä¾‹å¦‚ `rm`, `mv`, `cp`ï¼‰å‰ï¼Œå…ˆç”¨ `echo`ï¼š

```zsh
echo rm -rf "$target_dir"
```

ç¡®è®¤è¾“å‡ºå†å»æ‰ `echo`ã€‚

ä¹Ÿå¯ä»¥é€šè¿‡å˜é‡æ§åˆ¶ï¼š

```zsh
DRYRUN=1

if [[ $DRYRUN -eq 1 ]]; then
    echo "Would run: rm -rf $target_dir"
else
    rm -rf "$target_dir"
fi
```

âœ… å¥½å¤„ï¼š
ä¸éœ€è¦æ¯æ¬¡æ³¨é‡Šæ‰å±é™©å‘½ä»¤ï¼Œå¼€å…³ä¸€æ”¹å°±è¡Œã€‚

!! ğŸŸ¢ 3. ''åœ¨ä¸´æ—¶ç›®å½•é‡Œè°ƒè¯•''

å¦‚æœè„šæœ¬ä¼šæ“ä½œå¤§é‡æ–‡ä»¶ï¼Œå…ˆï¼š

```zsh
TMPDIR=$(mktemp -d)
```

æŠŠè„šæœ¬é€»è¾‘å®šå‘åˆ° `$TMPDIR`ï¼Œç¡®è®¤æ— è¯¯åå†åˆ‡æ¢åˆ°çœŸå®è·¯å¾„ã€‚

âœ… å¥½å¤„ï¼š
å³ä½¿é€»è¾‘æœ‰è¯¯ï¼Œä¹Ÿåªæ˜¯ç ´åä¸´æ—¶ç›®å½•ã€‚

!! ğŸŸ¢ 4. ''å¸¦äº¤äº’ç¡®è®¤''

åœ¨å…³é”®ç‚¹æ’å…¥ï¼š

```zsh
read "?About to delete $target_dir. Press Enter to continue or Ctrl+C to abort."
```

æˆ–è€…

```zsh
read -k "REPLY?Proceed? (y/n) "
[[ $REPLY == y ]] || exit 1
```

âœ… å¥½å¤„ï¼š
é˜²æ­¢â€œä¸€é”®å…¨æ¯â€ã€‚

!! ğŸŸ¢ 5. ''åˆ†æ­¥è°ƒè¯•''

å¦‚æœè„šæœ¬å¾ˆé•¿ï¼Œä¸è¦ä¸€å£æ°”æ‰§è¡Œåˆ°åº•ï¼Œå…ˆï¼š

* åˆ†æ®µæ‰§è¡Œ
* æ‰‹åŠ¨è¿è¡Œæ¯ä¸ªå—
* é€æ­¥éªŒè¯ç¯å¢ƒå˜é‡å’Œæ–‡ä»¶çŠ¶æ€

ä¹Ÿå¯ä»¥æŠŠè„šæœ¬åˆ†æˆå¤šä¸ªå°å‡½æ•°ï¼Œé€ä¸ªè°ƒè¯•ã€‚

!! ğŸŸ¢ 6. ''è°ƒè¯•è¾“å‡º''

åŠ ä¸Šè‡ªå·±çš„''æ—¥å¿—å‡½æ•°''ï¼š

```zsh
log() { print -P "%F{cyan}[DEBUG]%f $*"; }
```

åœ¨æ¯ä¸ªå…³é”®æ­¥éª¤æ‰“å°ï¼š

```zsh
log "Processing file $f"
```

âœ… å¥½å¤„ï¼š
æ¯”ç®€å•çš„ `echo` æ›´ç›´è§‚ã€‚

!! ğŸŸ¢ 7. ''trap æ•è·é”™è¯¯''

åœ¨è„šæœ¬å¼€å¤´ï¼š

```zsh
trap 'echo "Error at line $LINENO"; exit 1' ERR
```

å½“è„šæœ¬æŠ¥é”™æ—¶æ‰“å°é”™è¯¯è¡Œã€‚

!! ğŸŸ¢ 8. ''åœ¨ zsh è°ƒè¯•å™¨é‡Œè·‘ï¼ˆé«˜çº§ï¼‰''

zsh è‡ªå¸¦ä¸€ä¸ªè°ƒè¯•å™¨ï¼š

```zsh
zsh -D your_script.zsh
```

ä¹Ÿå¯ä»¥åœ¨äº¤äº’æ¨¡å¼ç”¨ï¼š

```zsh
autoload zsh/zprof
```

ä¸è¿‡è¿™ä¸ªç”¨å¾—ç›¸å¯¹è¾ƒå°‘ï¼Œå¸¸ç”¨è¿˜æ˜¯ `set -x` å’Œ echoã€‚

!! ğŸŸ¢ 9. ''ä½¿ç”¨ ShellCheck é™æ€åˆ†æ''

è™½ç„¶ ShellCheck æ˜¯å bash/shï¼Œä½†ä¹Ÿå¯¹ zsh æœ‰å¸®åŠ©ï¼š

```bash
shellcheck your_script.zsh
```

å¯ä»¥å‘ç°ï¼š

* æ‹¼å†™é”™è¯¯
* å¼•å·é—æ¼
* æ½œåœ¨é€»è¾‘é—®é¢˜

> å®‰è£…ï¼š

```
sudo apt install shellcheck
```

æˆ–

```
brew install shellcheck
```

!! ğŸ”µ å¸¸ç”¨ç»„åˆè°ƒè¯•å§¿åŠ¿

åœ¨å±é™©è„šæœ¬é‡Œï¼Œæˆ‘å¸¸ç”¨çš„ç»„åˆï¼š

```zsh
#!/usr/bin/env zsh
set -euxo pipefail
trap 'echo "Error at line $LINENO"' ERR

# åˆ›å»ºå®‰å…¨çš„ä¸´æ—¶ç›®å½•
TMPDIR=$(mktemp -d)
log() { print -P "%F{yellow}[INFO]%f $*"; }

log "Working directory: $TMPDIR"

# ä¸‹é¢å¹²è·‘
echo cp important_file "$TMPDIR/"
```

è°ƒè¯•ç»“æŸå†å»æ‰ `echo`ã€‚