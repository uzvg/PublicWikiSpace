created: 20250805065249227
description: ArchLinux NVIDIA ä¼‘çœ æ•…éšœæ·±åº¦æ’æŸ¥ä¸è§£å†³æ–¹æ¡ˆåˆ†æ
modified: 20250805071909982
modifier: uzvg
progress: Completed
rating: Plain
source: nvidia suspend error
tags: PermanentNotes ArchLinux NVIDIA TroubleShooting
title: ArchLinux NVIDIA ä¼‘çœ æ•…éšœè§£å†³æ–¹æ¡ˆåŠå…¶åˆ†æ
type: text/vnd.tiddlywiki
visibility: Public

!! å‰è¨€ï¼š

æˆ‘çš„å·¥ä½œç¯å¢ƒæ˜¯ArchLinux+NVIDIAæ˜¯æ˜¾å¡ï¼Œæœ€è¿‘ä¸€æ®µæ—¶é—´ï¼Œæˆ‘çš„ArchLinuxç³»ç»Ÿæ€»æ˜¯ä¸å®šæœŸå‡ºç°å¦‚ä¸‹æ•…éšœï¼š

* ç”µè„‘é™æ­¢ä¸€ä¼šå„¿å°±ä¼šå‡ºç°é»‘å±ï¼Œç„¶åé‡å¤è¾“å‡ºNVIDIAé”™è¯¯æŠ¥å‘Šã€‚
* æ£˜æ‰‹çš„ç‚¹åœ¨äºè¯¥æ•…éšœæ˜¯éå®šæœŸå‡ºç°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰æ—¶ç”µè„‘èƒ½æ­£å¸¸ä¼‘çœ ï¼Œä½†æœ‰æ—¶ï¼Œå°±ä¸èƒ½ï¼Œè¿™å°±å¾ˆè®©äººæ¼äººã€‚
* æˆ‘ä½¿ç”¨ç”µæºé”®ç‰©ç†é‡å¯åï¼Œä½¿ç”¨journalctlå‘½ä»¤æŸ¥çœ‹æ—¥å¿—ï¼Œæœ‰å¦‚ä¸‹è¾“å‡ºï¼š

```
Jun 16 09:05:33 ArchLinux flatpak[46996]: libostree HTTP error from remote flathub for <https://dl.flathub.org/repo/config  >:>
Jun 16 10:16:43 ArchLinux gdm[728]: GLib: Source ID 106 was not found when attempting to remove it
Jun 16 12:55:14 ArchLinux kernel: nvidia 0000:01:00.0: can't suspend (nv_pmops_runtime_suspend [nvidia] returned -5)
Jun 16 13:32:25 ArchLinux kernel: rtw89_8852ae 0000:04:00.0: AMD-Vi: Event logged [IO_PAGE_FAULT domain=0x0010 address=0x0 f>
Jun 16 17:21:58 ArchLinux kernel: nvidia-modeset: ERROR: GPU:0: Failed to query display engine channel state: 0x0000c67e:0:0>
Jun 16 17:21:58 ArchLinux kernel: nvidia-modeset: ERROR: GPU:0: Failed to query display engine channel state: 0x0000c67e:2:0>
Jun 16 17:21:58 ArchLinux kernel: nvidia-modeset: ERROR: GPU:0: Failed to query display engine channel state: 0x0000c67e:4:0>
```

æˆ‘ä¹‹å‰å°è¯•è¿‡çš„è§£å†³æ–¹æ¡ˆçœ‹èµ·æ¥éƒ½å·²ç»å¤±è´¥äº†ï¼Œä½†æ˜¯æœ€è¿‘ï¼Œæˆ‘å‘ç°åœ¨ArchWikiä¸­æ›´æ–°äº†å¦‚ä¸‹å†…å®¹ï¼š

> NVIDIA's open kernel modules cannot enable D3 Power Management on Turing. This reduces battery life on notebooks with Turing in an NVIDIA Optimus configuration. Use the proprietary module (e.g. nvidia) with module parameter NVreg_EnableGpuFirmware=0 instead. More information about this issueğŸ‘‰https://github.com/NVIDIA/open-gpu-kernel-modules/issues/640#issuecomment-2188114679  ã€‚

æˆ‘è®¤ä¸ºè¿™æ®µæè¿°åˆšå¥½å¯¹åº”æˆ‘é‡åˆ°çš„æ•…éšœï¼Œäºæ˜¯é‡æ–°å®‰è£…äº†`nvidia-dkms`ï¼Œåœ¨`/etc/modprobe.d/nvidia.conf`ä¸­å¼€å¯äº†`NVreg_EnableGpuFirmware=0`é€‰é¡¹ï¼Œç›®å‰ç¡®å®æ²¡é‡åˆ°è¿‡ä¼‘çœ æ•…éšœçš„æƒ…å†µå‘ç”Ÿã€‚ä½†ä»ç„¶ä¸èƒ½ç¡®å®šæ˜¯å¦æ˜¯è¯¥æ•…éšœçš„è§£å†³æ–¹æ¡ˆã€‚

!! 1. æ•…éšœæè¿°

* ç³»ç»Ÿï¼šArch Linux 6.15.9-zen, GNOME/Wayland
* GPUï¼šNVIDIA RTX 3050 Ti Mobile (Turing) + AMD iGPU (Optimus)
* ç°è±¡ï¼š
** ç©ºé—²è‡ªåŠ¨æŒ‚èµ·/æ‰‹åŠ¨ `systemctl suspend` â†’ éšæœºé»‘å±ï¼Œé£æ‰‡ç»§ç»­è¿è¡Œï¼Œå¿…é¡»ç”µæºé”®å¼ºåˆ¶é‡å¯ã€‚
** æ—¥å¿—å…³é”®è¡Œï¼š

```
kernel: nvidia 0000:01:00.0: can't suspend (nv_pmops_runtime_suspend [nvidia] returned -5)
kernel: nvidia-modeset: ERROR: GPU:0: Failed to query display engine channel state: 0x0000c67e:...
```

* å¤ç°ï¼šéå®šæœŸï¼Œä¸ç©ºé—²æ—¶æœºã€åå°ä»»åŠ¡å¹¶å‘æœ‰å…³ï¼ˆç«äº‰æ¡ä»¶ï¼‰ã€‚

!! 2. è§£å†³æ–¹æ¡ˆ

* 1. ç¡®ä¿ä½¿ç”¨''ä¸“æœ‰é©±åŠ¨''ï¼ˆé `nvidia-open`ï¼‰ï¼š

```
sudo pacman -S nvidia-dkms
```

* 2. åˆ›å»º/ç¼–è¾‘æ¨¡å—å‚æ•°æ–‡ä»¶ï¼š

```
sudo nano /etc/modprobe.d/nvidia.conf
```

å†…å®¹ï¼š

```
options nvidia NVreg_EnableGpuFirmware=0
```

* 3. é‡æ–°ç”Ÿæˆ initramfs å¹¶é‡å¯ï¼š

```
sudo mkinitcpio -P
sudo reboot
```

* 4. éªŒè¯ï¼šè¿è¡Œ `journalctl -b | grep -i nvidia` ç¡®è®¤å‚æ•°å·²ç”Ÿæ•ˆï¼›è¿ç»­ç©ºé—²æŒ‚èµ· 3â€“5 æ¬¡æœªå†å‡ºç°é»‘å±ã€‚

!! 3. ç–‘é—®ï¼š

; ä¸ºä»€ä¹ˆ nvidia-open ä¸èƒ½â€œåŒæ ·ç¦ç”¨â€ GSPï¼Ÿ
* ç¡¬ç¼–ç é™åˆ¶ï¼š`nvidia-open` æºç ä¸­ GSP å›ºä»¶åŠ è½½é€»è¾‘æ— è¿è¡Œæ—¶å¼€å…³ï¼Œç­‰ä»·äº `EnableGpuFirmware=1` å›ºå®šä¸ºçœŸã€‚
* è®¾è®¡ç›®æ ‡ï¼šNVIDIA å¸Œæœ›å¼€æºæ¨¡å—é•¿æœŸä¾èµ– GSP ä»¥ç®€åŒ–ä»£ç è·¯å¾„ï¼Œå› æ­¤æœªæš´éœ²ç¦ç”¨é€‰é¡¹ã€‚
* å½“å‰çŠ¶æ€ï¼šç¤¾åŒºè¡¥ä¸å°šæœªåˆå¹¶ï¼Œä¸»çº¿ `nvidia-open` æ— æ³•é€šè¿‡ä»»ä½•å‚æ•°å…³é—­ GSPï¼›è‹¥éœ€ç¦ç”¨ï¼Œåªèƒ½é€€å›ä¸“æœ‰é©±åŠ¨ã€‚
* æ‰€ä»¥åªæœ‰åœ¨é€€å›ä¸“æœ‰`nvidia`é©±åŠ¨çš„æƒ…å†µä¸‹æ‰èƒ½ä½¿`NVreg_EnableGpuFirmware`é€‰é¡¹ç”Ÿæ•ˆã€‚